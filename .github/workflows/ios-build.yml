name: Build iOS IPA

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
  push:
    tags:
      - 'v*'

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.5'
        channel: 'stable'
        cache: true
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Install dependencies
      run: |
        flutter --version
        flutter pub get
    
    - name: Decode environment file
      env:
        ENV_FILE: ${{ secrets.ENV_FILE }}
      run: |
        if [ -n "$ENV_FILE" ]; then
          echo "$ENV_FILE" | base64 -d > .env
          echo "Environment file decoded"
        else
          echo "Warning: ENV_FILE secret not set, using default configuration"
          cp .env.example .env 2>/dev/null || echo "No .env.example file found"
        fi
    
    - name: Install CocoaPods dependencies
      run: |
        cd ios
        pod install --repo-update
        cd ..
    
    - name: Configure code signing
      env:
        BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        if [ -n "$BUILD_CERTIFICATE_BASE64" ] && [ -n "$BUILD_PROVISION_PROFILE_BASE64" ]; then
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          
          # Import certificate and provisioning profile from secrets
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH
          
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          # Apply provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning Profiles
          
          echo "Code signing configured successfully"
        else
          echo "Warning: Code signing secrets not configured, building without code signing"
          echo "To enable code signing, set the following secrets:"
          echo "- BUILD_CERTIFICATE_BASE64: Base64 encoded .p12 certificate"
          echo "- P12_PASSWORD: Certificate password"
          echo "- BUILD_PROVISION_PROFILE_BASE64: Base64 encoded provisioning profile"
          echo "- KEYCHAIN_PASSWORD: Keychain password"
        fi
    
    - name: Build IPA
      run: |
        if [ -n "${{ secrets.BUILD_CERTIFICATE_BASE64 }}" ]; then
          # Build with code signing
          flutter build ipa \
            --release \
            --build-name=${{ github.ref_name }} \
            --export-options-plist=ios/ExportOptions.plist
        else
          # Build without code signing (for testing)
          flutter build ios --release --no-codesign
        fi
    
    - name: Upload IPA artifact
      if: success() && hashFiles('build/ios/ipa/*.ipa') != ''
      uses: actions/upload-artifact@v4
      with:
        name: xiaoai-bluetooth-ipa
        path: build/ios/ipa/*.ipa
        retention-days: 30
    
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build/ios/*.log
          ios/Pods/Pods.xcodeproj/project.pbxproj.log
        retention-days: 7
    
    - name: Clean up keychain
      if: always() && env.BUILD_CERTIFICATE_BASE64
      run: |
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
